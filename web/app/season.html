<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–µ–∑–æ–Ω–∞ ‚Äî FormulaOneBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
<div class="root">
    <div class="card">
        <button id="btn-back" class="btn-back" type="button">‚Üê <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span></button>
        <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–µ–∑–æ–Ω–∞</h2>
        <div class="year-selector" id="year-selector">
            <div class="year-buttons" id="year-buttons"></div>
            <div class="year-input">
                <input
                    id="year-input"
                    type="number"
                    inputmode="numeric"
                    min="1950"
                    max="2100"
                    placeholder="–ì–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2021)"
                >
                <button id="year-input-btn" type="button">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>
        <div id="season-content">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞—é –∫–∞–ª–µ–Ω–¥–∞—Ä—å...</p>
            </div>
        </div>
    </div>
</div>

<script src="static/js/common.js"></script>
<script>
let currentSeason = new Date().getFullYear();

async function loadSeason(season) {
    const container = document.getElementById('season-content');
    showLoading(container, '–ó–∞–≥—Ä—É–∂–∞—é –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–µ–∑–æ–Ω–∞...');

    try {
        const data = await apiRequest('/season', { season });

        if (!data.races || data.races.length === 0) {
            showEmpty(container, '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é —Å–µ–∑–æ–Ω–∞', 'üìÖ');
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let html = '<div class="season-list">';

        data.races.forEach(race => {
            const raceDate = new Date(race.date + 'T00:00:00');
            raceDate.setHours(0, 0, 0, 0);
            const isPast = raceDate < today;
            const isToday = raceDate.getTime() === today.getTime();

            const dateStr = formatDate(race.date);

            html += `
                <div class="season-item ${isPast ? 'past' : 'future'}">
                    <div class="season-round">${race.round.toString().padStart(2, '0')}</div>
                    <div class="season-info">
                        <div class="season-name">${race.event_name}</div>
                        <div class="season-location">üìç ${race.country}, ${race.location}</div>
                        <div class="season-date">üìÖ ${dateStr}</div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    } catch (e) {
        console.error(e);
        showError(container, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–µ–∑–æ–Ω–∞');
    }
}

function initYearSelector() {
    const selector = document.getElementById('year-buttons');
    const currentYear = new Date().getFullYear();
    const years = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1];

    years.forEach(year => {
        const btn = document.createElement('button');
        btn.className = `year-btn ${year === currentSeason ? 'active' : ''}`;
        btn.textContent = year;
        btn.addEventListener('click', () => {
            currentSeason = year;
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadSeason(year);
        });
        selector.appendChild(btn);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initTelegram();
    initBackButton('/');
    initYearSelector();
    loadSeason(currentSeason);

    const yearInput = document.getElementById('year-input');
    const yearInputBtn = document.getElementById('year-input-btn');

    if (yearInput && yearInputBtn) {
        yearInput.value = String(currentSeason);

        const applyYear = () => {
            const value = parseInt(yearInput.value, 10);
            if (isNaN(value)) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–æ–¥');
                return;
            }
            if (value < 1950 || value > 2100) {
                alert('–ì–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1950‚Äì2100');
                return;
            }
            currentSeason = value;

            // –ü–æ–¥—Å–≤–µ—Ç–∏–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ —Ç–∞–∫–∞—è –µ—Å—Ç—å
            document.querySelectorAll('.year-btn').forEach(b => {
                const y = parseInt(b.textContent, 10);
                if (y === currentSeason) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            });

            loadSeason(currentSeason);
        };

        yearInputBtn.addEventListener('click', applyYear);
        yearInput.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                applyYear();
            }
        });
    }
});
</script>
</body>
</html>
