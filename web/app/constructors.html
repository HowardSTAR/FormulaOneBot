<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö—É–±–æ–∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        /* –¢–µ –∂–µ —Å—Ç–∏–ª–∏, —á—Ç–æ –∏ —É –ø–∏–ª–æ—Ç–æ–≤ */
        .team-card {
            display: flex; align-items: center; background: var(--surface-color);
            border-bottom: 1px solid var(--border-color); padding: 12px 16px;
        }
        .team-card:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .team-card:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }

        .champion-card { border-radius: 12px !important; border-bottom: 1px solid #ffd700 !important; }

        .pos-box { width: 30px; font-weight: 800; font-size: 16px; color: var(--text-secondary); text-align: center; margin-right: 12px; }
        .pos-1 { color: var(--gold); font-size: 20px; }
        .pos-2 { color: var(--silver); font-size: 18px; }
        .pos-3 { color: var(--bronze); font-size: 18px; }

        .team-info { flex: 1; }
        .team-name-main { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 6px; }
        .team-points { background: rgba(255, 255, 255, 0.1); padding: 6px 10px; border-radius: 8px; font-weight: 700; font-size: 14px; min-width: 50px; text-align: center; }

        /* –ü–æ–∏—Å–∫ */
        .search-container { display: flex; gap: 8px; margin-bottom: 16px; }
        .search-input { flex: 1; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 16px; color: var(--text-primary); font-size: 16px; font-weight: 600; outline: none; }
        .search-input:focus { border-color: var(--primary); }
        .search-btn { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 0 16px; color: var(--text-primary); font-size: 18px; cursor: pointer; }
        .current-year-btn { background: var(--primary); border: none; border-radius: 12px; padding: 0 16px; color: white; font-weight: 700; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>
<div class="root">

    <a href="index.html" class="btn-back">‚¨ÖÔ∏è <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span></a>
    <h2>–ö—É–±–æ–∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤</h2>

    <div class="search-container">
        <input type="number" id="year-input" class="search-input" placeholder="–ì–æ–¥" inputmode="numeric">
        <button class="search-btn" onclick="handleSearch()">üîç</button>
        <button id="current-year-btn" class="current-year-btn" onclick="goCurrentYear()">2026</button>
    </div>

    <div id="teams-list" style="display: flex; flex-direction: column;">
        <div class="loading full-width">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

</div>

<script src="/static/js/common.js"></script>
<script>
    const currentRealYear = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();
        document.getElementById('current-year-btn').textContent = currentRealYear;
        document.getElementById('year-input').value = currentRealYear;

        await loadTeams(currentRealYear);

        document.getElementById('year-input').addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleSearch();
        });
    });

    function goCurrentYear() {
        const input = document.getElementById('year-input');
        input.value = currentRealYear;
        handleSearch();
    }

    async function handleSearch() {
        const year = parseInt(document.getElementById('year-input').value);
        const container = document.getElementById('teams-list');

        if (!year) return;

        if (year > currentRealYear) {
            container.innerHTML = `<div class="empty-state"><span class="empty-icon">üõ†Ô∏è</span><div class="empty-title">–ú–∞—à–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–æ–º–∞–ª–∞—Å—å</div><div class="empty-desc">–ò–Ω–∂–µ–Ω–µ—Ä—ã –µ—â–µ –Ω–µ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –±–æ–ª–∏–¥—ã ${year} –≥–æ–¥–∞.</div></div>`;
            return;
        }
        if (year < 1958) {
            // –ö—É–±–æ–∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤ –ø–æ—è–≤–∏–ª—Å—è –≤ 1958 (–ø–æ–∑–∂–µ —á–µ–º –ª–∏—á–Ω—ã–π –∑–∞—á–µ—Ç)
            container.innerHTML = `<div class="empty-state"><span class="empty-icon">üìú</span><div class="empty-title">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç</div><div class="empty-desc">–ö—É–±–æ–∫ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å 1958 –≥–æ–¥–∞.</div></div>`;
            return;
        }
        await loadTeams(year);
    }

    async function loadTeams(season) {
        const container = document.getElementById('teams-list');
        container.innerHTML = '<div class="loading full-width">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        try {
            const data = await apiRequest('/api/constructors', { season: season });

            if (!data.constructors || data.constructors.length === 0) {
                 if (season === currentRealYear) {
                    container.innerHTML = `<div class="empty-state"><span class="empty-icon">üèéÔ∏è</span><div class="empty-title">–°–µ–∑–æ–Ω –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è</div><div class="empty-desc">–ù–∏ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –µ—â–µ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ –æ—á–∫–∏.</div></div>`;
                } else {
                    container.innerHTML = `<div class="empty-state"><div class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`;
                }
                return;
            }

            renderList(data.constructors, season);

        } catch (error) {
            console.error(error);
            container.innerHTML = '<div style="color:red; text-align:center; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    function renderList(teams, season) {
        const container = document.getElementById('teams-list');
        container.innerHTML = '';

        teams.forEach(team => {
            const pos = team.position;
            let posClass = 'pos-other';
            if (pos === 1) posClass = 'pos-1';
            else if (pos === 2) posClass = 'pos-2';
            else if (pos === 3) posClass = 'pos-3';

            const favIcon = team.is_favorite ? '<span style="font-size:12px;">‚úÖ</span>' : '';
            const isChampion = (pos === 1 && season < currentRealYear);

            const div = document.createElement('div');

            if (isChampion) {
                div.className = 'team-card champion-card';
                div.innerHTML = `
                    <div class="champion-badge">Constructors Champion</div>
                    <div class="pos-box pos-1">1</div>
                    <div class="team-info">
                        <div class="team-name-main" style="color:#ffd700;">${team.name} ${favIcon}</div>
                    </div>
                    <div class="team-points" style="background:#ffd700; color:#000;">${team.points}</div>
                `;
            } else {
                div.className = 'team-card';
                div.innerHTML = `
                    <div class="pos-box ${posClass}">${pos}</div>
                    <div class="team-info">
                        <div class="team-name-main">${team.name} ${favIcon}</div>
                    </div>
                    <div class="team-points">${team.points} PTS</div>
                `;
            }
            container.appendChild(div);
        });
    }
</script>
</body>
</html>