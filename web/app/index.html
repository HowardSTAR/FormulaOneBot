<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>F1 Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .section-title {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 24px 0 8px 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }
        .hero-btn {
            background: linear-gradient(135deg, var(--primary), #b00500);
            color: white;
            padding: 20px;
            font-size: 18px;
            border: none;
            box-shadow: 0 8px 20px rgba(225, 6, 0, 0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .hero-sub {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
        }
        .hero-title {
            font-size: 20px;
            font-weight: 800;
            line-height: 1.2;
        }
        .hero-date {
            font-size: 14px;
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .hero-timer {
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
<div class="root">

    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 style="margin:0;"><span style="color: var(--primary);">F1</span> Hub</h2>
    </div>

    <a href="next-race.html" class="btn hero-btn" id="hero-btn">
        <div class="hero-sub" id="hero-sub">–ë–õ–ò–ñ–ê–ô–®–ò–ô –≠–¢–ê–ü</div>

        <div id="hero-title" class="hero-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="hero-date" class="hero-date">--.--</div>

        <div id="hero-timer" class="hero-timer" style="display: none;">
            <span style="font-size:12px; opacity:0.8; margin-right:4px;">–î–æ —Å—Ç–∞—Ä—Ç–∞:</span>
            <span id="timer-val" style="font-family: monospace; font-weight: 700;">--:--:--</span>
        </div>
    </a>

    <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø</div>
    <div class="results-grid">
        <a href="race-results.html" class="menu-item">
            <span class="menu-icon">üèÅ</span>
            <span class="menu-label">–ì–æ–Ω–∫–∞</span>
        </a>
        <a href="quali-results.html" class="menu-item">
            <span class="menu-icon">‚è±</span>
            <span class="menu-label">–ö–≤–∞–ª–∞</span>
        </a>
    </div>

    <div class="section-title" id="season-title">–°–µ–∑–æ–Ω</div>

    <div class="menu-grid">
        <a href="drivers.html" class="menu-item">
            <span class="menu-icon">üë§</span>
            <span class="menu-label">–ü–∏–ª–æ—Ç—ã</span>
        </a>
        <a href="constructors.html" class="menu-item">
            <span class="menu-icon">üèéÔ∏è</span>
            <span class="menu-label">–ö–æ–º–∞–Ω–¥—ã</span>
        </a>
        <a href="compare.html" class="menu-item">
            <span class="menu-icon">‚öîÔ∏è</span>
            <span class="menu-label">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
        </a>
        <a href="season.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="menu-icon">üìÖ</span>
                <span class="menu-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
            </div>
            <span>‚ûú</span>
        </a>
    </div>

    <div class="section-title">–ú–æ—ë</div>
    <a href="favorites.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px; border-color: rgba(255, 215, 0, 0.3); margin-bottom: 12px;">
        <div style="display:flex; align-items:center; gap:12px;">
            <span class="menu-icon">‚≠ê</span>
            <span class="menu-label" style="color: #ffd700;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </div>
        <span style="color: #ffd700;">‚ûú</span>
    </a>

    <a href="settings.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px;">
        <div style="display:flex; align-items:center; gap:12px;">
            <span class="menu-icon">‚öôÔ∏è</span>
            <span class="menu-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
        <span style="opacity: 0.5;">‚ûú</span>
    </a>

</div>

<script src="/static/js/common.js"></script>
<script>
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: "8 –ú–ê–†–¢–ê"
    function formatDateToText(dateStr) {
        if (!dateStr) return "";

        let day, month;

        // –í–∞—Ä–∏–∞–Ω—Ç 1: "08.03.2026" (–∏–∑ fmt_date/local)
        if (dateStr.includes('.')) {
            const parts = dateStr.split('.');
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
        }
        // –í–∞—Ä–∏–∞–Ω—Ç 2: "2026-03-08" (–∏–∑ date)
        else if (dateStr.includes('-')) {
            const parts = dateStr.split('-');
            day = parseInt(parts[2], 10);
            month = parseInt(parts[1], 10);
        } else {
            return dateStr;
        }

        const months = ["", "–Ø–ù–í–ê–†–Ø", "–§–ï–í–†–ê–õ–Ø", "–ú–ê–†–¢–ê", "–ê–ü–†–ï–õ–Ø", "–ú–ê–Ø", "–ò–Æ–ù–Ø", "–ò–Æ–õ–Ø", "–ê–í–ì–£–°–¢–ê", "–°–ï–ù–¢–Ø–ë–†–Ø", "–û–ö–¢–Ø–ë–†–Ø", "–ù–û–Ø–ë–†–Ø", "–î–ï–ö–ê–ë–†–Ø"];
        return `${day} ${months[month] || ""}`;
    }

    function initDynamicTimer(sessions) {
        // –ó–∞–º–µ–Ω–∏ —ç—Ç–∏ ID –Ω–∞ —Ç–µ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –≤–µ—Ä—Å—Ç–∫–µ —Ç–≤–æ–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        const timerValueEl = document.getElementById('timer-value');
        const sessionNameEl = document.getElementById('session-name'); // –õ–µ–π–±–ª –Ω–∞–¥ —Ç–∞–π–º–µ—Ä–æ–º
        const sessionDateEl = document.getElementById('session-date'); // –í—ã–≤–æ–¥ –¥–∞—Ç—ã

        // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5 —á–∞—Å–∞)
        // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –∫–æ–≥–¥–∞ —Å–µ—Å—Å–∏—è "–∏–¥–µ—Ç", –∞ –∫–æ–≥–¥–∞ —É–∂–µ "–∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å"
        const SESSION_DURATION = 90 * 60 * 1000;

        const timerInterval = setInterval(() => {
            const now = new Date();
            let activeSession = null;
            let status = 'completed'; // 'future' | 'running' | 'completed'

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ –∏—â–µ–º –ø–µ—Ä–≤—É—é –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
            for (let session of sessions) {
                const startTime = new Date(session.utc);
                const endTime = new Date(startTime.getTime() + SESSION_DURATION);

                if (now < startTime) {
                    activeSession = session;
                    status = 'future';
                    break;
                } else if (now >= startTime && now <= endTime) {
                    activeSession = session;
                    status = 'running';
                    break;
                }
            }

            // –ï—Å–ª–∏ —É–∏–∫-—ç–Ω–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω (–≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–æ—à–ª–∏)
            if (!activeSession) {
                clearInterval(timerInterval);
                sessionNameEl.textContent = "–£–∏–∫-—ç–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω";
                timerValueEl.textContent = "00:00:00";
                return;
            }

            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –î–ê–¢–£ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
            const sessionDate = new Date(activeSession.utc);
            sessionNameEl.textContent = activeSession.name;

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å —É—á–µ—Ç–æ–º —Ç–∞–π–º–∑–æ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            sessionDateEl.textContent = sessionDate.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long'
            });

            // 2. –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ "–∏–¥–µ—Ç"
            if (status === 'running') {
                timerValueEl.textContent = `${activeSession.name} –∏–¥–µ—Ç`;
            } else if (status === 'future') {
                const diff = sessionDate - now;

                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const m = Math.floor((diff / 1000 / 60) % 60);
                const s = Math.floor((diff / 1000) % 60);

                // –ï—Å–ª–∏ –¥–æ —Å–µ—Å—Å–∏–∏ –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–Ω–∏, –∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã:—Å–µ–∫—É–Ω–¥—ã
                if (d > 0) {
                    timerValueEl.textContent = `${d}–¥ ${pad(h)}:${pad(m)}:${pad(s)}`;
                } else {
                    timerValueEl.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
                }
            }
        }, 1000);

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π
        function pad(num) {
            return num.toString().padStart(2, '0');
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();

        const currentYear = new Date().getFullYear();
        document.getElementById('season-title').textContent = `–°–µ–∑–æ–Ω ${currentYear}`;

        try {
            const data = await apiRequest('/api/next-race');
            const titleEl = document.getElementById('hero-title');
            const dateEl = document.getElementById('hero-date');
            const subEl = document.getElementById('hero-sub');
            const timerBlock = document.getElementById('hero-timer');
            const timerVal = document.getElementById('timer-val');

if (data.status === 'ok') {
                titleEl.textContent = data.event_name;

                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∑–æ–Ω—ã
                const settings = await apiRequest('/api/settings').catch(() => ({ timezone: 'UTC' }));
                const userTz = settings.timezone || 'UTC';

                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
                    const schedule = await apiRequest('/api/weekend-schedule', {
                        season: data.season,
                        round_number: data.round
                    });

                    if (schedule && schedule.sessions && schedule.sessions.length > 0) {
                        timerBlock.style.display = 'block';
                        // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å–µ—Å—Å–∏—è –¥–ª–∏—Ç—Å—è ~1.5 —á–∞—Å–∞ (90 –º–∏–Ω—É—Ç).
                        // –í —Ç–µ—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±—É–¥–µ—Ç –≥–æ—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å "–°–ï–°–°–ò–Ø –ò–î–ï–¢"
                        const SESSION_DURATION = 90 * 60 * 1000;

                        function updateDynamicTimer() {
                            const now = new Date().getTime();
                            let activeSession = null;
                            let status = 'completed';

                            // –ò—â–µ–º —Ç–µ–∫—É—â—É—é –∏–ª–∏ –±–ª–∏–∂–∞–π—à—É—é –±—É–¥—É—â—É—é —Å–µ—Å—Å–∏—é
                            for (let session of schedule.sessions) {
                                if (!session.utc_iso) continue;

                                const startTime = new Date(session.utc_iso).getTime();
                                const endTime = startTime + SESSION_DURATION;

                                if (now < startTime) {
                                    activeSession = session;
                                    status = 'future';
                                    break;
                                } else if (now >= startTime && now <= endTime) {
                                    activeSession = session;
                                    status = 'running';
                                    break;
                                }
                            }

                            // –ï—Å–ª–∏ –≤—Å–µ —Å–µ—Å—Å–∏–∏ —É–∏–∫-—ç–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
                            if (!activeSession) {
                                if (window.mainTimer) clearInterval(window.mainTimer);
                                subEl.textContent = "–£–ò–ö-–≠–ù–î –ó–ê–í–ï–†–®–ï–ù";
                                timerBlock.style.display = 'none';
                                return;
                            }

                            // 1. –í–´–°–¢–ê–í–õ–Ø–ï–ú –î–ê–¢–£ –ò–ú–ï–ù–ù–û –≠–¢–û–ô –°–ï–°–°–ò–ò (–ü—Ä–∞–∫—Ç–∏–∫–∏/–ö–≤–∞–ª—ã/–ì–æ–Ω–∫–∏)
                            const dateObj = new Date(activeSession.utc_iso);
                            dateEl.textContent = dateObj.toLocaleDateString('ru-RU', {
                                timeZone: userTz,
                                day: 'numeric',
                                month: 'long'
                            }).toUpperCase();
                            dateEl.style.display = 'inline-block';

                            // 2. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° (–¢–∞–π–º–µ—Ä –∏–ª–∏ "LIVE")
                            if (status === 'running') {
                                subEl.innerHTML = `<span class="session-badge" style="background: white; color: #e10600;">LIVE: ${activeSession.name}</span>`;
                                timerVal.textContent = "–°–ï–°–°–ò–Ø –ò–î–ï–¢";
                            } else {
                                subEl.innerHTML = `<span class="session-badge">${activeSession.name}</span>`;

                                const distance = new Date(activeSession.utc_iso).getTime() - now;
                                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                                let text = "";
                                if (days > 0) text += `${days}–¥ `;
                                text += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                timerVal.textContent = text;
                            }
                        }

                        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ü–∏–∫–ª
                        updateDynamicTimer();
                        if (window.mainTimer) clearInterval(window.mainTimer);
                        window.mainTimer = setInterval(updateDynamicTimer, 1000);
                        return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –¥–∏–Ω–∞–º–∏–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞
                    }
                } catch (e) {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º Fallback", e);
                }

                // === FALLBACK (–ï—Å–ª–∏ API —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–æ) ===
                if (data.next_session_iso) {
                    const dateObj = new Date(data.next_session_iso);
                    dateEl.textContent = dateObj.toLocaleDateString('ru-RU', {
                        timeZone: userTz,
                        day: 'numeric',
                        month: 'long'
                    }).toUpperCase();
                } else {
                    let rawDate = data.fmt_date ? data.fmt_date.split(' ')[0] : (data.local ? data.local.split(' ')[0] : data.date);
                    dateEl.textContent = formatDateToText(rawDate);
                }

                if (data.next_session_iso && data.next_session_name) {
                    subEl.innerHTML = `<span class="session-badge">${data.next_session_name}</span>`;
                    const targetTime = new Date(data.next_session_iso).getTime();
                    timerBlock.style.display = 'block';

                    function fallbackUpdateTimer() {
                        const now = new Date().getTime();
                        const distance = targetTime - now;
                        if (distance < 0) {
                            clearInterval(window.mainTimer);
                            subEl.innerHTML = `<span class="session-badge" style="background: white; color: #e10600;">LIVE: ${data.next_session_name}</span>`;
                            timerVal.textContent = "–°–ï–°–°–ò–Ø –ò–î–ï–¢";
                            return;
                        }
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        let text = "";
                        if (days > 0) text += `${days}–¥ `;
                        text += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        timerVal.textContent = text;
                    }
                    fallbackUpdateTimer();
                    if(window.mainTimer) clearInterval(window.mainTimer);
                    window.mainTimer = setInterval(fallbackUpdateTimer, 1000);
                } else {
                    subEl.textContent = "–ë–õ–ò–ñ–ê–ô–®–ò–ô –≠–¢–ê–ü";
                }

            } else if (data.status === 'season_finished') {
                titleEl.textContent = "–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω";
                dateEl.style.display = 'none';
                subEl.textContent = "–î–û –í–°–¢–†–ï–ß–ò –í 2027!";
            } else {
                titleEl.textContent = "–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è";
                dateEl.style.display = 'none';
            }
        } catch (e) {
            console.error(e);
            document.getElementById('hero-title').textContent = "–û—à–∏–±–∫–∞";
        }
    });
</script>
</body>
</html>