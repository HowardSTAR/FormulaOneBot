<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>F1 Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .section-title {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 24px 0 8px 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }
        .hero-btn {
            background: linear-gradient(135deg, var(--primary), #b00500);
            color: white;
            padding: 20px;
            font-size: 18px;
            border: none;
            box-shadow: 0 8px 20px rgba(225, 6, 0, 0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .hero-sub {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
        }
        .hero-title {
            font-size: 20px;
            font-weight: 800;
            line-height: 1.2;
        }
        .hero-date {
            font-size: 14px;
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .hero-timer {
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
<div class="root">

    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 style="margin:0;"><span style="color: var(--primary);">F1</span> Hub</h2>
    </div>

    <a href="next-race.html" class="btn hero-btn" id="hero-btn">
        <div class="hero-sub" id="hero-sub">–ë–õ–ò–ñ–ê–ô–®–ò–ô –≠–¢–ê–ü</div>

        <div id="hero-title" class="hero-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="hero-date" class="hero-date">--.--</div>

        <div id="hero-timer" class="hero-timer" style="display: none;">
            <span style="font-size:12px; opacity:0.8; margin-right:4px;">–î–æ —Å—Ç–∞—Ä—Ç–∞:</span>
            <span id="timer-val" style="font-family: monospace; font-weight: 700;">--:--:--</span>
        </div>
    </a>

    <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø</div>
    <div class="results-grid">
        <a href="race-results.html" class="menu-item">
            <span class="menu-icon">üèÅ</span>
            <span class="menu-label">–ì–æ–Ω–∫–∞</span>
        </a>
        <a href="quali-results.html" class="menu-item">
            <span class="menu-icon">‚è±</span>
            <span class="menu-label">–ö–≤–∞–ª–∞</span>
        </a>
    </div>

    <div class="section-title" id="season-title">–°–µ–∑–æ–Ω</div>

    <div class="menu-grid">
        <a href="drivers.html" class="menu-item">
            <span class="menu-icon">üë§</span>
            <span class="menu-label">–ü–∏–ª–æ—Ç—ã</span>
        </a>
        <a href="constructors.html" class="menu-item">
            <span class="menu-icon">üèéÔ∏è</span>
            <span class="menu-label">–ö–æ–º–∞–Ω–¥—ã</span>
        </a>
        <a href="compare.html" class="menu-item">
            <span class="menu-icon">‚öîÔ∏è</span>
            <span class="menu-label">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
        </a>
        <a href="season.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="menu-icon">üìÖ</span>
                <span class="menu-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
            </div>
            <span>‚ûú</span>
        </a>
    </div>

    <div class="section-title">–ú–æ—ë</div>
    <a href="favorites.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px; border-color: rgba(255, 215, 0, 0.3); margin-bottom: 12px;">
        <div style="display:flex; align-items:center; gap:12px;">
            <span class="menu-icon">‚≠ê</span>
            <span class="menu-label" style="color: #ffd700;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </div>
        <span style="color: #ffd700;">‚ûú</span>
    </a>

    <a href="settings.html" class="menu-item full-width" style="flex-direction: row; justify-content: space-between; padding: 16px 24px;">
        <div style="display:flex; align-items:center; gap:12px;">
            <span class="menu-icon">‚öôÔ∏è</span>
            <span class="menu-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
        <span style="opacity: 0.5;">‚ûú</span>
    </a>

</div>

<script src="/static/js/common.js"></script>
<script>
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: "8 –ú–ê–†–¢–ê"
    function formatDateToText(dateStr) {
        if (!dateStr) return "";

        let day, month;

        // –í–∞—Ä–∏–∞–Ω—Ç 1: "08.03.2026" (–∏–∑ fmt_date/local)
        if (dateStr.includes('.')) {
            const parts = dateStr.split('.');
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
        }
        // –í–∞—Ä–∏–∞–Ω—Ç 2: "2026-03-08" (–∏–∑ date)
        else if (dateStr.includes('-')) {
            const parts = dateStr.split('-');
            day = parseInt(parts[2], 10);
            month = parseInt(parts[1], 10);
        } else {
            return dateStr;
        }

        const months = ["", "–Ø–ù–í–ê–†–Ø", "–§–ï–í–†–ê–õ–Ø", "–ú–ê–†–¢–ê", "–ê–ü–†–ï–õ–Ø", "–ú–ê–Ø", "–ò–Æ–ù–Ø", "–ò–Æ–õ–Ø", "–ê–í–ì–£–°–¢–ê", "–°–ï–ù–¢–Ø–ë–†–Ø", "–û–ö–¢–Ø–ë–†–Ø", "–ù–û–Ø–ë–†–Ø", "–î–ï–ö–ê–ë–†–Ø"];
        return `${day} ${months[month] || ""}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();

        const currentYear = new Date().getFullYear();
        document.getElementById('season-title').textContent = `–°–µ–∑–æ–Ω ${currentYear}`;

        try {
            const data = await apiRequest('/api/next-race');
            const titleEl = document.getElementById('hero-title');
            const dateEl = document.getElementById('hero-date');
            const subEl = document.getElementById('hero-sub');
            const timerBlock = document.getElementById('hero-timer');
            const timerVal = document.getElementById('timer-val');

            if (data.status === 'ok') {
                titleEl.textContent = data.event_name;

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –î–ê–¢–´ –° –ß–ê–°–û–í–´–ú –ü–û–Ø–°–û–ú ---
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º, –Ω–æ –∑–¥–µ—Å—å —É–ø—Ä–æ—Å—Ç–∏–º)
                // –î–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ª—É—á—à–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏—Ö –≤–º–µ—Å—Ç–µ, –∫–∞–∫ –≤ next-race.html
                // –ù–æ –¥–∞–∂–µ –±–µ–∑ —ç—Ç–æ–≥–æ, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã –±—Ä–∞—É–∑–µ—Ä–æ–º –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

                let displayDate = "";

                try {
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–∞–π–º–∑–æ–Ω—ã
                    const settings = await apiRequest('/api/settings').catch(() => ({ timezone: 'UTC' }));
                    const userTz = settings.timezone || 'UTC';

                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥–∞—Ç—É –≥–æ–Ω–∫–∏
                    const schedule = await apiRequest('/api/weekend-schedule', {
                        season: data.season,
                        round_number: data.round
                    });

                    const raceSession = schedule.sessions.find(s =>
                        s.name === '–ì–æ–Ω–∫–∞' || s.name === 'Race'
                    );

                    if (raceSession && raceSession.utc_iso) {
                        const dateObj = new Date(raceSession.utc_iso);
                        displayDate = dateObj.toLocaleDateString('ru-RU', {
                            timeZone: userTz,
                            day: 'numeric',
                            month: 'long'
                        }).toUpperCase();
                    }
                } catch (e) {
                    // console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Ç–æ—á–Ω–∏—Ç—å –¥–∞—Ç—É –ø–æ —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É", e);
                }

                // Fallback
                if (!displayDate) {
                    let rawDate = "";
                    if (data.fmt_date) rawDate = data.fmt_date.split(' ')[0];
                    else if (data.local) rawDate = data.local.split(' ')[0];
                    else rawDate = data.date;
                    displayDate = formatDateToText(rawDate);
                }

                dateEl.textContent = displayDate;
                // -------------------------------------------------------

                if (data.next_session_iso && data.next_session_name) {
                    subEl.innerHTML = `<span class="session-badge">${data.next_session_name}</span>`;
                    const targetTime = new Date(data.next_session_iso).getTime();
                    timerBlock.style.display = 'block';

                    function updateTimer() {
                        const now = new Date().getTime();
                        const distance = targetTime - now;
                        if (distance < 0) {
                            clearInterval(timerInterval);
                            subEl.innerHTML = `<span class="session-badge" style="background: white; color: #e10600;">LIVE: ${data.next_session_name}</span>`;
                            timerVal.textContent = "–°–ï–°–°–ò–Ø –ò–î–ï–¢";
                            return;
                        }
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        let text = "";
                        if (days > 0) text += `${days}–¥ `;
                        text += `${hours}—á ${minutes}–º ${seconds}—Å`;
                        timerVal.textContent = text;
                    }
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                } else {
                    subEl.textContent = "–ë–õ–ò–ñ–ê–ô–®–ò–ô –≠–¢–ê–ü";
                }

            } else if (data.status === 'season_finished') {
                titleEl.textContent = "–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω";
                dateEl.style.display = 'none';
                subEl.textContent = "–î–û –í–°–¢–†–ï–ß–ò –í 2027!";
            } else {
                titleEl.textContent = "–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è";
                dateEl.style.display = 'none';
            }
        } catch (e) {
            console.error(e);
            document.getElementById('hero-title').textContent = "–û—à–∏–±–∫–∞";
        }
    });
</script>
</body>
</html>