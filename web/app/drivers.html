<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–õ–∏—á–Ω—ã–π –∑–∞—á–µ—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .driver-card {
            display: flex; align-items: center; background: var(--surface-color);
            border-bottom: 1px solid var(--border-color); padding: 12px 16px;
            transition: transform 0.2s;
        }
        .driver-card:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .driver-card:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }

        .champion-card { border-radius: 12px !important; border-bottom: 1px solid #ffd700 !important; }

        .pos-box { width: 30px; font-weight: 800; font-size: 16px; color: var(--text-secondary); text-align: center; margin-right: 12px; }
        .pos-1 { color: var(--gold); font-size: 20px; }
        .pos-2 { color: var(--silver); font-size: 18px; }
        .pos-3 { color: var(--bronze); font-size: 18px; }

        .driver-info { flex: 1; }
        .driver-name { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 6px; }
        .team-name { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 2px; }
        .driver-points { background: rgba(255, 255, 255, 0.1); padding: 6px 10px; border-radius: 8px; font-weight: 700; font-size: 14px; min-width: 50px; text-align: center; }

        .search-container { display: flex; gap: 8px; margin-bottom: 16px; width: 100%; box-sizing: border-box; }
        .search-input { flex: 1 1 auto; min-width: 0; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 16px; color: var(--text-primary); font-size: 16px; font-weight: 600; outline: none; }
        .search-input::placeholder { font-size: 13px; color: var(--text-secondary); opacity: 0.7; }
        .search-input:focus { border-color: var(--primary); }
        .search-btn { flex-shrink: 0; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 0 16px; color: var(--text-primary); font-size: 18px; cursor: pointer; }
        .current-year-btn { flex-shrink: 0; white-space: nowrap; background: var(--primary); border: none; border-radius: 12px; padding: 0 16px; color: white; font-weight: 700; font-size: 14px; cursor: pointer; }    </style>

    </style>
</head>
<body>
<div class="root">
    <a href="index.html" class="btn-back">
        ‚Üê <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
    </a>
    <h2>–õ–∏—á–Ω—ã–π –∑–∞—á–µ—Ç</h2>

    <div class="search-container">
        <input type="number" id="year-input" class="search-input" placeholder="–í–≤–µ–¥–∏ –≥–æ–¥" inputmode="numeric">
        <button class="search-btn" onclick="handleSearch()">üîç</button>
        <button id="current-year-btn" class="current-year-btn" onclick="goCurrentYear()">2026</button>
    </div>

    <div id="drivers-list" style="display: flex; flex-direction: column;">
        <div class="loading full-width">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<script src="/static/js/common.js"></script>
<script>
    const currentRealYear = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();
        document.getElementById('current-year-btn').textContent = currentRealYear;
        await loadDrivers(currentRealYear);

        document.getElementById('year-input').addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleSearch();
        });
    });

    function goCurrentYear() {
        const input = document.getElementById('year-input');
        input.value = currentRealYear;
        handleSearch();
    }

    async function handleSearch() {
        const year = parseInt(document.getElementById('year-input').value);
        const container = document.getElementById('drivers-list');

        if (!year) return;

        if (year > currentRealYear) {
            container.innerHTML = `<div class="empty-state"><span class="empty-icon">üîÆ</span><div class="empty-title">–ë—É–¥—É—â–µ–µ —Ç—É–º–∞–Ω–Ω–æ</div><div class="empty-desc">–ú—ã –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞–µ–º, –∫—Ç–æ —Å—Ç–∞–Ω–µ—Ç —á–µ–º–ø–∏–æ–Ω–æ–º –≤ ${year} –≥–æ–¥—É.</div></div>`;
            return;
        }
        if (year < 1950) {
            container.innerHTML = `<div class="empty-state"><span class="empty-icon">ü¶ñ</span><div class="empty-title">–°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ</div><div class="empty-desc">–ü–µ—Ä–≤—ã–π —Å–µ–∑–æ–Ω –§–æ—Ä–º—É–ª—ã-1 –ø—Ä–æ—à–µ–ª –≤ 1950 –≥–æ–¥—É.</div></div>`;
            return;
        }
        await loadDrivers(year);
    }

    async function loadDrivers(season) {
        const container = document.getElementById('drivers-list');
        container.innerHTML = '<div class="loading full-width">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        try {
            const data = await apiRequest('/api/drivers', { season: season });

            if (!data.drivers || data.drivers.length === 0) {
                if (season === currentRealYear) {
                    container.innerHTML = `<div class="empty-state"><span class="empty-icon">üèéÔ∏è</span><div class="empty-title">–°–µ–∑–æ–Ω –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è</div><div class="empty-desc">–ü–µ—Ä–≤–∞—è –≥–æ–Ω–∫–∞ –µ—â–µ –≤–ø–µ—Ä–µ–¥–∏. –¢–∞–±–ª–∏—Ü–∞ –æ—á–∫–æ–≤ –ø—É—Å—Ç–∞.</div></div>`;
                } else {
                    container.innerHTML = `<div class="empty-state"><div class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div><div class="empty-desc">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ ${season} –≥–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</div></div>`;
                }
                return;
            }

            renderList(data.drivers, season);

        } catch (error) {
            console.error(error);
            container.innerHTML = '<div style="color:red; text-align:center; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    function renderList(drivers, season) {
        const container = document.getElementById('drivers-list');
        container.innerHTML = '';

        drivers.forEach(driver => {
            const pos = driver.position;
            let posClass = 'pos-other';
            if (pos === 1) posClass = 'pos-1';
            else if (pos === 2) posClass = 'pos-2';
            else if (pos === 3) posClass = 'pos-3';

            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–≤–µ–∑–¥–∞ –≤–º–µ—Å—Ç–æ –≥–∞–ª–æ—á–∫–∏
            const favIcon = driver.is_favorite ? '<span style="font-size:14px; margin-left:4px;">‚≠êÔ∏è</span>' : '';

            const isChampion = (pos === 1 && season < currentRealYear);

            const div = document.createElement('div');

            if (isChampion) {
                div.className = 'driver-card champion-card';
                div.innerHTML = `
                    <div class="champion-badge">World Champion</div>
                    <div class="pos-box pos-1">1</div>
                    <div class="driver-info">
                        <div class="driver-name" style="color:#ffd700;">${driver.name} ${favIcon}</div>
                        <div class="team-name" style="color:rgba(255,255,255,0.7);">${driver.code}</div>
                    </div>
                    <div class="driver-points" style="background:#ffd700; color:#000;">${driver.points}</div>
                `;
            } else {
                div.className = 'driver-card';
                div.innerHTML = `
                    <div class="pos-box ${posClass}">${pos}</div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name} ${favIcon}</div>
                        <div class="team-name">${driver.code}</div>
                    </div>
                    <div class="driver-points">${driver.points}</div>
                `;
            }
            container.appendChild(div);
        });
    }
</script>
</body>
</html>