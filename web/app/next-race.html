<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ª–∏–∂–∞–π—à–∞—è –≥–æ–Ω–∫–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
<div class="root">

    <a href="index.html" class="btn-back">
        ‚¨ÖÔ∏è <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
    </a>

    <h2 id="race-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    <p id="race-location" style="margin-bottom: 20px; opacity: 0.7;">...</p>

    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">–°–¢–ê–†–¢ –ì–û–ù–ö–ò</div>
            <div id="race-time-local" style="font-size: 24px; font-weight: 800; color: var(--primary);">--:--</div>
            <div id="race-date" style="font-size: 16px; margin-top: 4px;">--.--.----</div>
        </div>
    </div>

    <h3 style="margin-left: 4px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–∏–∫–µ–Ω–¥–∞</h3>
    <div id="weekend-list" class="standings-list">
        <div class="loading">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ...</div>
        </div>
    </div>

</div>

<script src="/static/js/common.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp

        const listEl = document.getElementById('weekend-list');
        const titleEl = document.getElementById('race-title');
        const locEl = document.getElementById('race-location');
        const timeEl = document.getElementById('race-time-local');
        const dateEl = document.getElementById('race-date');

        try {
            // 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ –æ –≥–æ–Ω–∫–µ
            const raceData = await apiRequest('/api/next-race');

            if (raceData.status === 'season_finished') {
                titleEl.textContent = "–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω";
                locEl.textContent = "";
                listEl.innerHTML = '<div style="padding:20px; text-align:center;">–ì–æ–Ω–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å üèÅ</div>';
                return;
            }

            if (raceData.status !== 'ok') {
                titleEl.textContent = "–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è";
                listEl.innerHTML = '';
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É
            titleEl.textContent = raceData.event_name;
            locEl.textContent = `${raceData.country}, ${raceData.location}`;

            // –í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ (–∏–∑ —Å—Ç—Ä–æ–∫–∏ "local" —Ñ–æ—Ä–º–∞—Ç–∞ "DD.MM.YYYY HH:MM –ú–°–ö")
            // –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º UTC –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–∞–º–∏.
            // raceData.local –ø—Ä–∏—Ö–æ–¥–∏—Ç –≥–æ—Ç–æ–≤—ã–º –æ—Ç –±–æ—Ç–∞ (—Å–º. races.py)
            if (raceData.local) {
                // raceData.local = "15.03.2025 18:00 –ú–°–ö"
                const parts = raceData.local.split(' ');
                dateEl.textContent = parts[0];
                timeEl.textContent = parts[1];
            } else {
                dateEl.textContent = raceData.date;
                timeEl.textContent = "TBA";
            }

            // 2. –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π
            // –ù–∞–º –Ω—É–∂–µ–Ω season –∏ round
            const season = raceData.season;
            const round = raceData.round;

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–∏–∫–µ–Ω–¥–∞
            const scheduleData = await apiRequest('/api/weekend-schedule', {
                season: season,
                round_number: round
            });

            // –û—á–∏—â–∞–µ–º –ª–æ–∞–¥–µ—Ä
            listEl.innerHTML = '';

            if (scheduleData && scheduleData.sessions) {
                scheduleData.sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'standings-item';

                    // –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–π —Å–µ—Å—Å–∏–π (–ø—Ä–æ—Å—Ç–æ–π –º–∞–ø–ø–∏–Ω–≥)
                    let nameRu = session.name;
                    if (nameRu === 'Practice 1') nameRu = '–ü—Ä–∞–∫—Ç–∏–∫–∞ 1';
                    if (nameRu === 'Practice 2') nameRu = '–ü—Ä–∞–∫—Ç–∏–∫–∞ 2';
                    if (nameRu === 'Practice 3') nameRu = '–ü—Ä–∞–∫—Ç–∏–∫–∞ 3';
                    if (nameRu === 'Qualifying') nameRu = '–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è';
                    if (nameRu === 'Sprint') nameRu = '–°–ø—Ä–∏–Ω—Ç';
                    if (nameRu === 'Race') nameRu = '–ì–æ–Ω–∫–∞';

                    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML
                    item.innerHTML = `
                        <div class="standings-info">
                            <div class="standings-name">${nameRu}</div>
                            <div class="standings-code" style="color: var(--primary);">
                                ${session.date} ‚Ä¢ ${session.time}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } else {
                listEl.innerHTML = '<div style="padding:10px;">–ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</div>';
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "–û—à–∏–±–∫–∞";
            listEl.innerHTML = `<div style="color:red; text-align:center;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.<br>${error.message}</div>`;
        }
    });
</script>
</body>
</html>