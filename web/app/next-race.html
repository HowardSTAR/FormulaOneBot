<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ª–∏–∂–∞–π—à–∞—è –≥–æ–Ω–∫–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        #race-time-local {
            white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É */
            text-transform: uppercase; /* –ú–µ—Å—è—Ü –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ */
        }
    </style>
</head>
<body>
<div class="root">

    <a href="index.html" class="btn-back">
        ‚Üê <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
    </a>

    <h2 id="race-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    <p id="race-location" style="margin-bottom: 20px; opacity: 0.7;">...</p>

    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">–°–¢–ê–†–¢ –ì–û–ù–ö–ò</div>
            <div id="race-time-local" style="font-size: 24px; font-weight: 800; color: var(--primary);">--</div>
            <div id="race-date" style="font-size: 16px; margin-top: 4px;">--:--</div>
        </div>
    </div>

    <h3 style="margin-left: 4px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–∏–∫–µ–Ω–¥–∞</h3>
    <div id="weekend-list" class="standings-list">
        <div class="loading">
            <div class="spinner"></div>
            <div>–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ...</div>
        </div>
    </div>

</div>

<script src="/static/js/common.js"></script>
<script>
    function formatDateToText(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return dateStr;

        let day, month;

        if (dateStr.includes('.')) {
            const parts = dateStr.split('.');
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
        } else if (dateStr.includes('-')) {
            const parts = dateStr.split('-');
            day = parseInt(parts[2], 10);
            month = parseInt(parts[1], 10);
        } else {
            return dateStr;
        }

        const months = ["", "–Ø–ù–í–ê–†–Ø", "–§–ï–í–†–ê–õ–Ø", "–ú–ê–†–¢–ê", "–ê–ü–†–ï–õ–Ø", "–ú–ê–Ø", "–ò–Æ–ù–Ø", "–ò–Æ–õ–Ø", "–ê–í–ì–£–°–¢–ê", "–°–ï–ù–¢–Ø–ë–†–Ø", "–û–ö–¢–Ø–ë–†–Ø", "–ù–û–Ø–ë–†–Ø", "–î–ï–ö–ê–ë–†–Ø"];
        return `${day} ${months[month] || ""}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();

        const listEl = document.getElementById('weekend-list');
        const titleEl = document.getElementById('race-title');
        const locEl = document.getElementById('race-location');
        const bigTextEl = document.getElementById('race-time-local');
        const smallTextEl = document.getElementById('race-date');

        try {
            // 1. –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.allSettled —á—Ç–æ–±—ã –æ—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –ª–æ–º–∞–ª–∞ –≤—Å—ë
            const [raceDataRes, settingsRes] = await Promise.allSettled([
                apiRequest('/api/next-race'),
                apiRequest('/api/settings')
            ]);

            const raceData = raceDataRes.status === 'fulfilled' ? raceDataRes.value : { status: 'error' };
            // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –ø—Ä–∏—à–ª–∏, fallback –Ω–∞ UTC
            const settings = settingsRes.status === 'fulfilled' ? settingsRes.value : { timezone: 'UTC' };
            const userTz = settings.timezone || 'UTC';

            if (raceData.status !== 'ok') {
                titleEl.textContent = raceData.status === 'season_finished' ? "–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω" : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
                listEl.innerHTML = '';
                return;
            }

            titleEl.textContent = raceData.event_name;
            locEl.textContent = `${raceData.country}, ${raceData.location}`;

            // --- –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò (–ì–ª–∞–≤–Ω–∞—è –≥–æ–Ω–∫–∞) ---
            const fullDateStr = raceData.fmt_date || raceData.local;

            if (fullDateStr && fullDateStr.includes(' ')) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è (08.03.2026 07:00)
                const parts = fullDateStr.split(' ');
                const datePart = parts[0];
                const timePart = parts[1];

                bigTextEl.textContent = formatDateToText(datePart); // "8 –ú–ê–†–¢–ê"
                smallTextEl.textContent = timePart;              // "07:00"
            } else {
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ (TBA)
                const rawDate = raceData.date;
                bigTextEl.textContent = formatDateToText(rawDate) || rawDate;
                smallTextEl.textContent = "TBA";
            }

            // --- –†–ê–°–ü–ò–°–ê–ù–ò–ï –£–ò–ö–ï–ù–î–ê ---
            const scheduleData = await apiRequest('/api/weekend-schedule', {
                season: raceData.season,
                round_number: raceData.round
            });

            listEl.innerHTML = '';

            if (scheduleData && scheduleData.sessions && scheduleData.sessions.length > 0) {
                scheduleData.sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'standings-item';

                    let sessionTime = "--:--";
                    let sessionDate = "--.--";

                    // üëá –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ JS –±—Ä–∞—É–∑–µ—Ä–∞
                    if (session.utc_iso) {
                        try {
                            const dateObj = new Date(session.utc_iso);

                            // –í—Ä–µ–º—è (HH:MM) –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            sessionTime = dateObj.toLocaleTimeString('ru-RU', {
                                timeZone: userTz,
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            // –î–∞—Ç–∞ (DD.MM) –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            sessionDate = dateObj.toLocaleDateString('ru-RU', {
                                timeZone: userTz,
                                day: '2-digit',
                                month: '2-digit'
                            });

                        } catch (e) {
                            console.error("Date error:", e);
                            sessionTime = session.utc || "--:--";
                        }
                    }
                    // Fallback (–µ—Å–ª–∏ –Ω–µ—Ç ISO, –∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
                    else if (session.local && session.local.includes(' ')) {
                        const parts = session.local.split(' ');
                        sessionDate = parts[0].slice(0, 5); // "06.03"
                        sessionTime = parts[1];             // "04:30"
                    } else if (session.utc) {
                        sessionTime = session.utc;
                    }

                    item.innerHTML = `
                        <div class="standings-info">
                            <div class="standings-name" style="font-size: 16px;">${session.name}</div>
                            <div class="standings-code" style="color: var(--text-secondary); margin-top: 4px;">
                                <span style="color: var(--primary); font-weight: 700;">${sessionTime}</span>
                                <span style="margin: 0 6px; opacity: 0.3;">|</span>
                                ${sessionDate}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } else {
                listEl.innerHTML = '<div style="padding:20px; text-align:center;">–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</div>';
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
            listEl.innerHTML = "";
        }
    });
</script>
</body>
</html>