<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ближайшая гонка</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        #race-time-local {
            white-space: nowrap; /* Не переносить строку */
            text-transform: uppercase; /* Месяц заглавными */
        }
    </style>
</head>
<body>
<div class="root">

    <a href="index.html" class="btn-back">
        ← <span>Главное меню</span>
    </a>

    <h2 id="race-title">Загрузка...</h2>
    <p id="race-location" style="margin-bottom: 20px; opacity: 0.7;">...</p>

    <div class="card">
        <div style="text-align: center;">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">СТАРТ ГОНКИ</div>
            <div id="race-time-local" style="font-size: 24px; font-weight: 800; color: var(--primary);">--</div>
            <div id="race-date" style="font-size: 16px; margin-top: 4px;">--:--</div>
        </div>
    </div>

    <h3 style="margin-left: 4px;">Расписание уикенда</h3>
    <div id="weekend-list" class="standings-list">
        <div class="loading">
            <div class="spinner"></div>
            <div>Загружаем расписание...</div>
        </div>
    </div>

</div>

<script src="/static/js/common.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        initTelegram();

        const listEl = document.getElementById('weekend-list');
        const titleEl = document.getElementById('race-title');
        const locEl = document.getElementById('race-location');
        const bigTextEl = document.getElementById('race-time-local'); // Сюда пойдет ДАТА (как у тебя было)
        const smallTextEl = document.getElementById('race-date');     // Сюда пойдет ВРЕМЯ

        try {
            // 1. Получаем базовые данные и настройки
            const [raceDataRes, settingsRes] = await Promise.allSettled([
                apiRequest('/api/next-race'),
                apiRequest('/api/settings')
            ]);

            const raceData = raceDataRes.status === 'fulfilled' ? raceDataRes.value : { status: 'error' };
            const settings = settingsRes.status === 'fulfilled' ? settingsRes.value : { timezone: 'UTC' };
            const userTz = settings.timezone || 'UTC';

            if (raceData.status !== 'ok') {
                titleEl.textContent = raceData.status === 'season_finished' ? "Сезон завершен" : "Нет данных";
                listEl.innerHTML = '';
                return;
            }

            titleEl.textContent = raceData.event_name;
            locEl.textContent = `${raceData.country}, ${raceData.location}`;

            // 2. Загружаем расписание
            const scheduleData = await apiRequest('/api/weekend-schedule', {
                season: raceData.season,
                round_number: raceData.round
            });

            // 3. --- НОВАЯ ЛОГИКА ДЛЯ "ЖЕЛТОЙ ЗОНЫ" (Шапка) ---
            // Ищем сессию "Гонка" или "Race", чтобы взять её точное ISO время
            let raceSession = null;
            if (scheduleData && scheduleData.sessions) {
                raceSession = scheduleData.sessions.find(s =>
                    s.name === 'Гонка' || s.name === 'Race'
                );
            }

            if (raceSession && raceSession.utc_iso) {
                // Если нашли гонку, конвертируем её ISO время в часовой пояс юзера
                const dateObj = new Date(raceSession.utc_iso);

                // Дата: "8 марта" (с учетом сдвига часового пояса!)
                const datePart = dateObj.toLocaleDateString('ru-RU', {
                    timeZone: userTz,
                    day: 'numeric',
                    month: 'long'
                }).toUpperCase(); // "8 МАРТА"

                // Время: "07:00"
                const timePart = dateObj.toLocaleTimeString('ru-RU', {
                    timeZone: userTz,
                    hour: '2-digit',
                    minute: '2-digit'
                });

                bigTextEl.textContent = datePart;
                smallTextEl.textContent = timePart;
            } else {
                // Fallback, если вдруг расписание не пришло (берем старый fmt_date)
                // Но этот случай редкий
                bigTextEl.textContent = raceData.date || "TBA";
                smallTextEl.textContent = "--:--";
            }

            // 4. --- ЛОГИКА ДЛЯ "СИНЕЙ ЗОНЫ" (Список) ---
            listEl.innerHTML = '';

            if (scheduleData && scheduleData.sessions && scheduleData.sessions.length > 0) {
                scheduleData.sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'standings-item';

                    let sessionTime = "--:--";
                    let sessionDate = "--.--";

                    if (session.utc_iso) {
                        try {
                            const dateObj = new Date(session.utc_iso);

                            sessionTime = dateObj.toLocaleTimeString('ru-RU', {
                                timeZone: userTz,
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            sessionDate = dateObj.toLocaleDateString('ru-RU', {
                                timeZone: userTz,
                                day: '2-digit',
                                month: '2-digit'
                            });
                        } catch (e) {
                            sessionTime = session.utc || "--:--";
                        }
                    }

                    item.innerHTML = `
                        <div class="standings-info">
                            <div class="standings-name" style="font-size: 16px;">${session.name}</div>
                            <div class="standings-code" style="color: var(--text-secondary); margin-top: 4px;">
                                <span style="color: var(--primary); font-weight: 700;">${sessionTime}</span>
                                <span style="margin: 0 6px; opacity: 0.3;">|</span>
                                ${sessionDate}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } else {
                listEl.innerHTML = '<div style="padding:20px; text-align:center;">Нет расписания</div>';
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "Ошибка загрузки";
            listEl.innerHTML = "";
        }
    });
</script>
</body>
</html>